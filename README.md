# Celstate

Celstate is an AI-first pipeline for generating transparent PNG assets using dual-pass image generation and difference matting. The system includes a core generation library, web interface with authentication, and both API and CLI interfaces.

## What It Does

- Generates a **white pass** and a **black pass** using Gemini 2.5 Flash Image.
- Uses **difference matting** to extract alpha and produce a transparent PNG.
- Produces a structured **component manifest** with layout metadata and telemetry.
- Provides **user authentication** via Google OAuth through Convex Auth.
- Offers **web interface** and **API** for asset generation.

## Architecture

### Image Pipeline
```
User Prompt
  -> CreativeInterpreter (Kimi-K2)
  -> White Pass (Gemini 2.5 Flash Image)
  -> Edit to Black Pass
  -> MediaProcessor (difference matting + layout analysis)
  -> Transparent PNG + Component Manifest
```

### Web Application
```
Landing Page (/landing/)
  -> Sign In -> Web App (/app/)
  -> Google OAuth via Convex Auth
  -> Dashboard with user-scoped asset access
```

### Data Layer
- **Convex Backend**: Auth, jobs, assets, and user data
- **Service Key Pattern**: Pipeline syncs via service-only mutations
- **User Scoping**: Authenticated users access only their data

## Enduring Setup Notes (AI Agents)

These are the non-obvious, long-term setup decisions that must stay consistent.

### Hosting + Routing
- **Static hosting on Cloudflare Pages** (free + durable). The frontend is **purely static**.
- **Landing page** lives at `/landing/` (static HTML in `landing/`).
- **Web app** lives at `/app/` (Vite build). The build outputs to `dist/app`.
- **Root URL `/` redirects to `/landing/`** via `dist/index.html` generated by `scripts/build_static.mjs`.
- Vite config forces **production base path `/app/`**. Do not change this without updating links and auth redirects.
- Build command for hosting:
  ```bash
  npm --prefix web install
  npm --prefix web run build
  node scripts/build_static.mjs
  ```

### Auth + Convex
- **Convex Auth** handles Google OAuth. Production `SITE_URL` must be your public domain.
- OAuth callback is always `https://<deployment>.convex.site/api/auth/callback/google`.
- **Service key pattern** is required for the Python pipeline sync (`SERVICE_KEY`).
- Web app sign-in redirects to `/app/` after OAuth.

### Domains
- Domain ownership: **celstate.com** on Namecheap.
- Recommended setup is `www.celstate.com` on Cloudflare Pages + apex redirect to `www`.

## Requirements

### Environment Variables

**Core Pipeline:**
```
VERTEX_API_KEY=...
VERTEX_PROJECT_ID=...
VERTEX_LOCATION=...
HF_TOKEN=...
```

**Authentication (Convex):**
```
SITE_URL=http://localhost:5173  # Frontend origin
JWT_PRIVATE_KEY=...             # Generated via node generateKeys.mjs
JWKS=...                        # Generated via node generateKeys.mjs
AUTH_GOOGLE_ID=...              # Google OAuth client ID
AUTH_GOOGLE_SECRET=...          # Google OAuth client secret
SERVICE_KEY=...                 # For pipeline sync access
VITE_CONVEX_URL=...             # Convex deployment URL
```

### Python

- Python 3.12+
- Dependencies are managed via `pyproject.toml` / `uv.lock`.

### Node.js (Web App)

- Node.js 18+
- Web app dependencies in `web/package.json`

## Install

```bash
# Python dependencies
uv sync

# Node.js dependencies (web app)
cd web && npm install && cd ..
```

## Development Setup

### 1. Start Convex Backend

```bash
npx convex dev
```

Set up environment variables in Convex dashboard and locally (see Requirements above).

### 2. Start Web App

```bash
cd web
npm run dev
```

Visit `http://localhost:5173` for the landing page, `http://localhost:5173/app/` for the authenticated web app.

### 3. Generate JWT Keys (one-time)

```bash
node generateKeys.mjs
```

Add the generated `JWT_PRIVATE_KEY` and `JWKS` to your environment variables.

## Deployment

### Production Deployment (Cloudflare Pages â†’ Convex â†’ Namecheap)

1. **Cloudflare Pages**: Host the landing + app bundle
   - Create a Cloudflare Pages project for this repo
   - Build: `npm --prefix web install && npm --prefix web run build && node scripts/build_static.mjs`
   - Publish the `dist/` directory (serves `/landing/` + `/app/`)

2. **Convex**: Production auth config
   - Set production environment variables in Convex dashboard
   - Update Google Cloud Console with production domain
   - Configure OAuth callbacks for production

3. **Namecheap**: Point custom domain to Cloudflare Pages
   - Add custom domain in Cloudflare Pages
   - Configure DNS records (CNAME for subdomain, redirect or Cloudflare DNS for root)
   - HTTPS auto-provisions on Cloudflare Pages

4. **Verification**
   - Test OAuth flow at `https://<your-domain>/app/`
   - Verify auth tables populate in Convex production

## CLI (Internal)

Generate a transparent image:

```
celstate generate "a glowing health potion bottle" -o output.png
```

Common flags:

- `--style-context` (optional)
- `--render-size-hint` (optional, integer)
- `--layout-intent` (optional, defaults to auto)
- `--name` (optional)
- `--asset-type` (optional override)

Process existing white/black passes:

```
celstate process white.png black.png -o output.png
```

List jobs:

```
celstate jobs
```

Version:

```
celstate version
```

## API (Canonical)

The API is a thin adapter over the core library.

Run locally:

```
uvicorn src.mcp_server:app --reload
```

### POST /v1/assets

Request:

```json
{
  "prompt": "string",
  "style_context": "string",
  "asset_type": "container|icon|texture|effect|image|decoration",
  "layout_intent": "auto|row|column|...",
  "render_size_hint": 160,
  "name": "string"
}
```

Response:

```json
{
  "job_id": "uuid",
  "status": "queued"
}
```

### GET /v1/assets/{job_id}

Queued/Running:

```json
{
  "job_id": "uuid",
  "status": "processing",
  "retry_after": 10
}
```

Succeeded:

```json
{
  "job_id": "uuid",
  "status": "succeeded",
  "component": { ... }
}
```

Failed:

```json
{
  "job_id": "uuid",
  "status": "failed",
  "error": "human-readable error",
  "retry_after": 60
}
```

## Job Artifacts

Each job creates a directory under `jobs/{job_id}/`:

```
job.json
studio/     # white + black passes
outputs/    # final PNG + debug overlays/mask
trace/trace.json
```

## Testing

Run the test suite:

```
uv run pytest
```

Note: If `tests/test_analyzer.py` fails due to legacy method references, run:

```
uv run pytest --ignore=tests/test_analyzer.py
```

## Reference

- **Canonical contract**: `docs/interface_contract.md`
- **Implementation plan**: `implementation_plan.md` (Convex Auth - Complete)
- **Project status**: `update_plan.md`
- **Next steps**: `next_steps.md`

## Implementation Status

### âœ… Complete
- **Convex Auth Implementation** (Phases 0-6)
  - Google OAuth integration
  - React web app with authentication
  - User-scoped data access
  - Service key pattern for pipeline sync
  - Landing page wired to auth entry points

### ðŸ”„ In Progress
- **CLI Architecture Refactoring**
  - Migrate CLI to use `Orchestrator` as canonical interface
  - Add missing `style_context` and `render_size_hint` support
  - Ensure comprehensive tracing integration

### ðŸ“‹ Planned
- **Dashboard UX** for asset generation and management
- **API key issuance/management** for service access
- **Video pipeline** alternatives (see `update_plan.md` for research)
