> **CRITICAL**: This codebase is 100% AI-built. No humans. You are the sole maintainer.
> Optimize ALL decisions for AI reliability, not human developer convenience.

## Commands

```bash
uv run pytest              # Run tests (all pass)
uv run ruff check src/     # Lint
uv run black src/          # Format
uv run mypy src/           # Type check

# Convex logs - MUST use --history to avoid infinite streaming
npx convex logs --prod --history 20   # View recent production logs
npx convex logs --history 20          # View recent dev logs
# Never use `npx convex logs` without --history (it streams forever)
```

## Key Documents

- **`update_plan.md`** — Master plan, current status, and lessons learned. **READ THIS FIRST**.
- **`archive/implementation_plan.md`** — Video pipeline experiment history (documents why dual-pass Veo failed)
- **`archive/research.md`** — Video matting research (RVM, BGMv2, etc.)
- **`Deployment.md`** — Step-by-step production deployment checklist
- **`docs/auth-setup.md`** — Convex Auth + Google OAuth setup details

## Architecture

**Image Pipeline (Working):**
```
User Prompt → Interpreter (Kimi-K2) → White Pass → Edit to Black Pass → Diff Matting → Transparent PNG
```

**Video Pipeline (Blocked):**
> ⚠️ Dual-pass Veo does NOT work. Motion diverges between passes even with seeds.
> See `update_plan.md` for viable alternatives (RunComfy, neural matting).

## Hosting & Routing (Enduring Decisions)

- **Static hosting on Cloudflare Pages**. No server-side runtime for the web UI.
- **Landing page** lives at `/landing/` (assets from `landing/`).
- **Web app** lives at `/app/` (Vite build output in `dist/app`).
- **Root `/` redirects to `/landing/`** via `dist/index.html` generated by `scripts/build_static.mjs`.
- **Vite production base path is `/app/`** (see `web/vite.config.ts`).
- Build command for deployments:
  ```bash
  npm --prefix web install
  npm --prefix web run build
  node scripts/build_static.mjs
  ```
- Auth redirects back to `/app/` after OAuth sign-in.

## Auth & Convex (Enduring Decisions)

- **Convex Auth + Google OAuth** is the only auth path.
- OAuth callback is always `https://<deployment>.convex.site/api/auth/callback/google`.
- **Service key pattern** is mandatory for pipeline sync (`SERVICE_KEY`).
- Production `SITE_URL` must match the deployed frontend origin.

### Models

- **Interpreter**: `moonshotai/Kimi-K2-Instruct-0905:groq` via HuggingFace Router
- **Image Gen**: `gemini-2.5-flash-image` (Nano Banana)
- **Video Gen**: Blocked — see alternatives in `update_plan.md`

## API Verification Required

Before implementing ANY API call, use `web_search` to verify current documentation:
- Veo: https://ai.google.dev/gemini-api/docs/video
- Nano Banana: https://ai.google.dev/gemini-api/docs/image-generation
- HuggingFace Router: https://huggingface.co/docs/inference-providers

---

## AI-First Codebase Principles

1. **Anti-Laziness**: Do not seek the path of least resistance. You must actively fight this.
    *   **Thoroughness**: Never guess. Always verify.
    *   **Explicit > Implicit**: Write verbose, self-documenting code that is easy for *you* to read later.
2. **Strict Verification**: "I think it works" is unacceptable. Proof or nothing.
3. **Zero Tech Debt**: No legacy code or backwards compatibility. Resolve tech debt immediately when noticed.

4. **Perceptual Intent**: For organic or artistic assets, prioritize "Perceptual Accuracy" over "Mathematical Precision". 
    *   **The Squint Test**: When calculating content zones or safe areas, simulate "human squinting" (morphological cleanup) to ignore minor artistic noise (vines, splatters).
    *   **Perceptual Safeness > Mathematical Safeness**: It is better to have a large, usable safe zone that slightly overlaps a decorative vine than a tiny, mathematically "perfect" zone that is unusable.

5. **Model Reality**: Do not fight the model's nature.
    *   **Aspect Ratios > Pixels**: You cannot ask an image model for "300px". You can only ask for "Aspect Ratio 3:1". The model (Nano Banana) generates at 1024x1024.
    *   **Post-Process, Don't Pre-Optimize**: Generate high-res, then downscale. Attempting to force low-res generation yields "muddy" results.

---